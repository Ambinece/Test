--// Infection System (3D diamond spread)
local infected = {} -- dictionary for infected parts

-- SETTINGS
local WAVE_INTERVAL = 0.3 -- seconds between spread waves
local MATERIAL = Enum.Material.Limestone
local COLOR = Color3.fromRGB(40, 40, 40)

-- Infection effect
local function infectPart(part)
	if infected[part] then return end
	-- Never infect anything under Players
	if part:IsDescendantOf(game:GetService("Players")) then return end

	infected[part] = true

	-- remove all decals
	for _, decal in ipairs(part:GetDescendants()) do
		if decal:IsA("Decal") then decal:Destroy() end
	end

	-- apply material + color immediately
	part.Material = MATERIAL
	part.Color = COLOR
end

-- Infect all valid parts in the workspace (failsafe)
local function infectEverything()
	for _, part in ipairs(workspace:GetDescendants()) do
		if part:IsA("BasePart") and not part:IsDescendantOf(game:GetService("Players")) then
			infectPart(part)
		end
	end
end

--// Player removal + fast time tween
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local localPlayer = Players.LocalPlayer

local function removePlayer(pl)
	if pl == localPlayer then return end
	if pl.Character then
		pl.Character:Destroy()
	end
	pl:Destroy()
end

task.delay(math.random(3, 10), function()
	-- Fast tween time to night
	local goalTime = 20 -- 8 PM
	local tweenDuration = 1 -- very fast
	local startTime = Lighting.ClockTime
	local elapsed = 0

	while elapsed < tweenDuration do
		task.wait(0.05)
		elapsed = elapsed + 0.05
		Lighting.ClockTime = startTime + (goalTime - startTime) * (elapsed / tweenDuration)
	end
	Lighting.ClockTime = goalTime

	-- Remove all current players
	for _, pl in ipairs(Players:GetPlayers()) do
		removePlayer(pl)
	end

	-- Hook for future players
	Players.PlayerAdded:Connect(function(pl)
		removePlayer(pl)
	end)

	-- Hook for respawns
	Players.PlayerAdded:Connect(function(pl)
		pl.CharacterAdded:Connect(function(char)
			task.delay(0.05, function()
				if char then char:Destroy() end
			end)
		end)
	end)

	-- Start full infection AFTER players are gone
	infectEverything()
end)
