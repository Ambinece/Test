--// Infection System (3D spread with full coverage)
local infected = {}

-- SETTINGS
local SEED_COUNT = 5
local WAVE_INTERVAL = 0.3
local FAILSAFE_DELAY = 10
local MISTAKE_CHANCE = 0.05
local MATERIAL = Enum.Material.Limestone
local COLOR = Color3.fromRGB(0, 0, 0) -- pure black
local SPREAD_RADIUS = 6 -- how far to check for nearby uninfected parts

-- Infection effect
local function infectPart(part)
	if infected[part] then return end
	if part:IsDescendantOf(game:GetService("Players")) then return end
	infected[part] = true

	-- Remove all decals and textures
	for _, obj in ipairs(part:GetDescendants()) do
		if obj:IsA("Decal") or obj:IsA("Texture") then
			obj:Destroy()
		end
	end

	part.Material = MATERIAL
	part.Color = COLOR
end

-- Valid target check
local function isValidTarget(part)
	return part:IsA("BasePart")
		and not infected[part]
		and part.Transparency < 1
		and part.CanCollide
		and not part:IsDescendantOf(game:GetService("Players"))
end

-- Spread infection to any nearby uninfected parts
local function spreadFrom(part)
	for _, p in ipairs(workspace:GetDescendants()) do
		if isValidTarget(p) and (p.Position - part.Position).Magnitude <= SPREAD_RADIUS then
			infectPart(p)
		end
	end
end

-- Failsafe: infect everything remaining in workspace
local function failsafeSpread()
	for _, part in ipairs(workspace:GetDescendants()) do
		if isValidTarget(part) then
			infectPart(part)
		end
	end
end

-- Main infection loop
local function startInfection()
	task.spawn(function()
		local spreadableParts = {}
		for _, part in ipairs(workspace:GetDescendants()) do
			if isValidTarget(part) then
				table.insert(spreadableParts, part)
			end
		end

		-- Pick seeds
		local seeds = {}
		for i = 1, math.min(SEED_COUNT, #spreadableParts) do
			local pick = spreadableParts[math.random(1, #spreadableParts)]
			infectPart(pick)
			table.insert(seeds, pick)
		end

		local lastSpread = os.clock()

		while true do
			task.wait(WAVE_INTERVAL)
			local anyInfected = false

			for _, part in ipairs(workspace:GetDescendants()) do
				if infected[part] then
					spreadFrom(part)
					anyInfected = true
				end
			end

			-- Random mistake infections
			for i = 1, #spreadableParts do
				if math.random() < MISTAKE_CHANCE then
					local pick = spreadableParts[math.random(1,#spreadableParts)]
					if isValidTarget(pick) then
						infectPart(pick)
						anyInfected = true
					end
				end
			end

			if not anyInfected or os.clock() - lastSpread > FAILSAFE_DELAY then
				failsafeSpread()
				lastSpread = os.clock()
			else
				lastSpread = os.clock()
			end
		end
	end)
end

--// Player removal + smooth dark night with black fog
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local localPlayer = Players.LocalPlayer

local function removePlayer(pl)
	if pl == localPlayer then return end
	if pl.Character then pl.Character:Destroy() end
	pl:Destroy()
end

task.delay(math.random(3,10), function()
	-- Smooth night transition
	local goalTime = 20
	local tweenDuration = 3
	local startTime = Lighting.ClockTime
	local elapsed = 0

	-- Set lighting fully dark
	Lighting.Brightness = 0
	Lighting.Ambient = Color3.new(0, 0, 0)
	Lighting.FogColor = Color3.new(0, 0, 0)
	Lighting.FogStart = 0
	Lighting.FogEnd = 100 -- adjust for desired density

	while elapsed < tweenDuration do
		task.wait(0.05)
		elapsed = elapsed + 0.05
		Lighting.ClockTime = startTime + (goalTime - startTime) * (elapsed / tweenDuration)
		Lighting.Brightness = 0
		Lighting.Ambient = Color3.new(0, 0, 0)
		Lighting.FogColor = Color3.new(0, 0, 0)
	end

	Lighting.ClockTime = goalTime
	Lighting.Brightness = 0
	Lighting.Ambient = Color3.new(0, 0, 0)
	Lighting.FogColor = Color3.new(0, 0, 0)

	-- Remove all current players
	for _, pl in ipairs(Players:GetPlayers()) do
		removePlayer(pl)
	end

	-- Hook for future players
	Players.PlayerAdded:Connect(function(pl) removePlayer(pl) end)
	Players.PlayerAdded:Connect(function(pl)
		pl.CharacterAdded:Connect(function(char)
			task.delay(0.05,function()
				if char then char:Destroy() end
			end)
		end)
	end)

	-- Start infection AFTER players removed
	startInfection()
end)
